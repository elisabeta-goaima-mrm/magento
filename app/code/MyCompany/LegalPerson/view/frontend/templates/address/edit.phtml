<?php
/** @var \Magento\Customer\Block\Address\Edit $block */
$company = $block->getAddress()->getCustomAttribute('legal_company') ? $block->getAddress()->getCustomAttribute('legal_company')->getValue() : '';
$cui = $block->getAddress()->getCustomAttribute('legal_cui') ? $block->getAddress()->getCustomAttribute('legal_cui')->getValue() : '';
$isLegal = !empty($cui);

$getAttrVal = function($code) use ($block) {
    $attr = $block->getAddress()->getCustomAttribute($code);
    return $attr ? $block->escapeHtmlAttr($attr->getValue()) : '';
};
?>
<form class="form-address-edit"
      action="<?= $block->escapeUrl($block->getSaveUrl()) ?>"
      method="post"
      id="form-validate"
      enctype="multipart/form-data"
      data-hasrequired="<?= $block->escapeHtmlAttr(__('* Required Fields')) ?>">
    <fieldset class="fieldset">
        <legend class="legend"><span><?= $block->escapeHtml(__('Contact Information')) ?></span></legend><br>
        <?= $block->getBlockHtml('formkey') ?>
        <input type="hidden" name="success_url" value="<?= $block->escapeUrl($block->getSuccessUrl()) ?>">
        <input type="hidden" name="error_url" value="<?= $block->escapeUrl($block->getErrorUrl()) ?>">

        <div class="field choice">
            <input type="checkbox" name="is_legal_checkbox" id="is_legal_checkbox" value="1" title="Persoana Juridica" class="checkbox" <?= $isLegal ? 'checked' : '' ?>>
            <label for="is_legal_checkbox" class="label"><span><?= $block->escapeHtml(__('Legal Entity')) ?></span></label>
        </div>

        <div class="field legal-field" style="display: none;">
            <label class="label" for="legal_company"><span><?= $block->escapeHtml(__('Company Name')) ?></span></label>
            <div class="control">
                <input type="text" name="legal_company" id="legal_company" value="<?= $block->escapeHtmlAttr($company) ?>" title="Nume Companie" class="input-text">
            </div>
        </div>

        <div class="field legal-field" style="display: none;">
            <label class="label" for="legal_cui"><span><?= $block->escapeHtml(__('CUI')) ?></span></label>
            <div class="control">
                <input type="text" name="legal_cui" id="legal_cui" value="<?= $block->escapeHtmlAttr($cui) ?>" title="CUI" class="input-text">
            </div>
        </div>

        <?= $block->getNameBlockHtml() ?>

        <div class="field company">
            <label class="label" for="company"><span><?= $block->escapeHtml(__('Company')) ?></span></label>
            <div class="control">
                <input type="text" name="company" id="company" title="<?= $block->escapeHtmlAttr(__('Company')) ?>" value="<?= $block->escapeHtmlAttr($block->getAddress()->getCompany()) ?>" class="input-text <?= $block->escapeHtmlAttr($this->helper(\Magento\Customer\Helper\Address::class)->getAttributeValidationClass('company')) ?>">
            </div>
        </div>

        <div class="field telephone required">
            <label class="label" for="telephone"><span><?= $block->escapeHtml(__('Phone Number')) ?></span></label>
            <div class="control">
                <input type="text" name="telephone" value="<?= $block->escapeHtmlAttr($block->getAddress()->getTelephone()) ?>" title="<?= $block->escapeHtmlAttr(__('Phone Number')) ?>" class="input-text <?= $block->escapeHtmlAttr($this->helper(\Magento\Customer\Helper\Address::class)->getAttributeValidationClass('telephone')) ?>" id="telephone">
            </div>
        </div>
        <div class="field fax">
            <label class="label" for="fax"><span><?= $block->escapeHtml(__('Fax')) ?></span></label>
            <div class="control">
                <input type="text" name="fax" id="fax" title="<?= $block->escapeHtmlAttr(__('Fax')) ?>" value="<?= $block->escapeHtmlAttr($block->getAddress()->getFax()) ?>" class="input-text <?= $block->escapeHtmlAttr($this->helper(\Magento\Customer\Helper\Address::class)->getAttributeValidationClass('fax')) ?>">
            </div>
        </div>
    </fieldset>
    <fieldset class="fieldset">
        <legend class="legend"><span><?= $block->escapeHtml(__('Address')) ?></span></legend><br>
        <?php $_streetValidationClass = $this->helper(\Magento\Customer\Helper\Address::class)->getAttributeValidationClass('street'); ?>
        <div class="field street required">
            <label for="street_1" class="label"><span><?= $block->escapeHtml(__('Street Address')) ?></span></label>
            <div class="control">
                <input type="text" name="street[]" value="<?= $block->escapeHtmlAttr($block->getStreetLine(1)) ?>" title="<?= $block->escapeHtmlAttr(__('Street Address')) ?>" id="street_1" class="input-text <?= $block->escapeHtmlAttr($_streetValidationClass) ?>">
                <div class="nested">
                    <?php $_streetValidationClass = trim(str_replace('required-entry', '', $_streetValidationClass)); ?>
                    <?php for ($_i = 2, $_n = $this->helper(\Magento\Customer\Helper\Address::class)->getStreetLines(); $_i <= $_n; $_i++): ?>
                        <div class="field additional">
                            <label class="label" for="street_<?= /* @noEscape */ $_i ?>">
                                <span><?= $block->escapeHtml(__('Street Address %1', $_i)) ?></span>
                            </label>
                            <div class="control">
                                <input type="text" name="street[]" value="<?= $block->escapeHtmlAttr($block->getStreetLine($_i)) ?>" title="<?= $block->escapeHtmlAttr(__('Street Address %1', $_i)) ?>" id="street_<?= /* @noEscape */ $_i ?>" class="input-text <?= $block->escapeHtmlAttr($_streetValidationClass) ?>">
                            </div>
                        </div>
                    <?php endfor; ?>
                </div>
            </div>
        </div>

        <div class="field additional-details">
            <div class="field legal-address-short-field">
                <label class="label" for="street_number"><span><?= $block->escapeHtml(__('Numar')) ?></span></label>
                <div class="control">
                    <input type="text" name="street_number" id="street_number" value="<?= $getAttrVal('street_number') ?>" title="<?= $block->escapeHtmlAttr(__('Numar')) ?>" class="input-text">
                </div>
            </div>
            <div class="field legal-address-short-field">
                <label class="label" for="building"><span><?= $block->escapeHtml(__('Bloc')) ?></span></label>
                <div class="control">
                    <input type="text" name="building" id="building" value="<?= $getAttrVal('building') ?>" title="<?= $block->escapeHtmlAttr(__('Bloc')) ?>" class="input-text">
                </div>
            </div>
            <div class="field legal-address-short-field">
                <label class="label" for="floor"><span><?= $block->escapeHtml(__('Etaj')) ?></span></label>
                <div class="control">
                    <input type="text" name="floor" id="floor" value="<?= $getAttrVal('floor') ?>" title="<?= $block->escapeHtmlAttr(__('Etaj')) ?>" class="input-text">
                </div>
            </div>
            <div class="field legal-address-short-field">
                <label class="label" for="apartment"><span><?= $block->escapeHtml(__('Apartament')) ?></span></label>
                <div class="control">
                    <input type="text" name="apartment" id="apartment" value="<?= $getAttrVal('apartment') ?>" title="<?= $block->escapeHtmlAttr(__('Apartament')) ?>" class="input-text">
                </div>
            </div>
        </div>
        <?php if ($this->helper(\Magento\Customer\Helper\Address::class)->isVatAttributeVisible()): ?>
            <div class="field taxvat">
                <label class="label" for="taxvat"><span><?= $block->escapeHtml(__('VAT Number')) ?></span></label>
                <div class="control">
                    <input type="text" name="vat_id" value="<?= $block->escapeHtmlAttr($block->getAddress()->getVatId()) ?>" title="<?= $block->escapeHtmlAttr(__('VAT Number')) ?>" class="input-text <?= $block->escapeHtmlAttr($this->helper(\Magento\Customer\Helper\Address::class)->getAttributeValidationClass('vat_id')) ?>" id="vat_id">
                </div>
            </div>
        <?php endif; ?>
        <div class="field country required">
            <label class="label" for="country"><span><?= $block->escapeHtml(__('Country')) ?></span></label>
            <div class="control">
                <?= $block->getCountryHtmlSelect() ?>
            </div>
        </div>
        <div class="field region required">
            <label class="label" for="region_id"><span><?= $block->escapeHtml(__('State/Province')) ?></span></label>
            <div class="control">
                <select id="region_id" name="region_id" title="<?= $block->escapeHtmlAttr(__('State/Province')) ?>" class="validate-select region_id" <?= (!$block->getConfig('general/region/display_all')) ? ' disabled="disabled"' : '' ?>>
                    <option value=""><?= $block->escapeHtml(__('Please select a region, state or province.')) ?></option>
                </select>
                <input type="text" id="region" name="region" value="<?= $block->escapeHtmlAttr($block->getRegion()) ?>"  title="<?= $block->escapeHtmlAttr(__('State/Province')) ?>" class="input-text <?= $block->escapeHtmlAttr($this->helper(\Magento\Customer\Helper\Address::class)->getAttributeValidationClass('region')) ?>"<?= (!$block->getConfig('general/region/display_all')) ? ' disabled="disabled"' : '' ?>/>
            </div>
        </div>

        <div class="field city required">
            <label class="label" for="city"><span><?= $block->escapeHtml(__('City')) ?></span></label>
            <div class="control">
                <input type="text" name="city" value="<?= $block->escapeHtmlAttr($block->getAddress()->getCity()) ?>" title="<?= $block->escapeHtmlAttr(__('City')) ?>" class="input-text <?= $block->escapeHtmlAttr($this->helper(\Magento\Customer\Helper\Address::class)->getAttributeValidationClass('city')) ?>" id="city">
                <select id="city_select" class="validate-select" style="display:none;">
                    <option value=""><?= __('Please select a city') ?></option>
                </select>
            </div>
        </div>

        <div class="field zip required">
            <label class="label" for="zip"><span><?= $block->escapeHtml(__('Zip/Postal Code')) ?></span></label>
            <div class="control">
                <input type="text" name="postcode" value="<?= $block->escapeHtmlAttr($block->getAddress()->getPostcode()) ?>" title="<?= $block->escapeHtmlAttr(__('Zip/Postal Code')) ?>" id="zip" class="input-text validate-zip-international <?= $block->escapeHtmlAttr($this->helper(\Magento\Customer\Helper\Address::class)->getAttributeValidationClass('postcode')) ?>">
            </div>
        </div>

        <?php if ($block->isDefaultBilling()): ?>
            <div class="message info">
                <span><?= $block->escapeHtml(__("It's a default billing address.")) ?></span>
            </div>
        <?php elseif ($block->canSetAsDefaultBilling()): ?>
            <div class="field choice set billing">
                <input type="checkbox" id="primary_billing" name="default_billing" value="1" class="checkbox">
                <label class="label" for="primary_billing"><span><?= $block->escapeHtml(__('Use as my default billing address')) ?></span></label>
            </div>
        <?php endif; ?>

        <?php if ($block->isDefaultShipping()): ?>
            <div class="message info">
                <span><?= $block->escapeHtml(__("It's a default shipping address.")) ?></span>
            </div>
        <?php elseif ($block->canSetAsDefaultShipping()): ?>
            <div class="field choice set shipping">
                <input type="checkbox" id="primary_shipping" name="default_shipping" value="1" class="checkbox">
                <label class="label" for="primary_shipping"><span><?= $block->escapeHtml(__('Use as my default shipping address')) ?></span></label>
            </div>
        <?php endif; ?>
    </fieldset>
    <div class="actions-toolbar">
        <div class="primary">
            <button type="submit" class="action save primary" data-action="save-address" title="<?= $block->escapeHtmlAttr(__('Save Address')) ?>">
                <span><?= $block->escapeHtml(__('Save Address')) ?></span>
            </button>
        </div>
        <div class="secondary">
            <a class="action back" href="<?= $block->escapeUrl($block->getBackUrl()) ?>"><span><?= $block->escapeHtml(__('Go back')) ?></span></a>
        </div>
    </div>
</form>

<script>
    require(['jquery', 'mage/url', 'mage/mage'], function($, url){
        var form = $('#form-validate');
        form.mage('validation', {});

        // === LEGAL ENTITY LOGIC ===
        var checkbox = $('#is_legal_checkbox');
        var legalFields = $('.legal-field');
        var legalInputs = $('.legal-field input');

        var firstname = $('input[name="firstname"]');
        var lastname = $('input[name="lastname"]');
        var company = $('input[name="company"]');

        var firstnameContainer = firstname.closest('.field');
        var lastnameContainer = lastname.closest('.field');
        var companyContainer = company.closest('.field');
        var legalCompanyInput = $('#legal_company');

        function toggleLegal(isInitial) {
            if (checkbox.is(':checked')) {
                legalFields.show();
                legalInputs.addClass('required-entry');

                // Ascundem campurile standard irelevante
                firstnameContainer.hide();
                lastnameContainer.hide();
                companyContainer.hide();

                if(!firstname.val()) firstname.val('Legal Entity');
            } else {
                legalFields.hide();
                legalInputs.removeClass('required-entry');

                firstnameContainer.show();
                lastnameContainer.show();
                companyContainer.show();

                if (firstname.val() === 'Legal Entity') {
                    firstname.val('');
                    lastname.val('');
                }
            }
        }

        legalCompanyInput.on('input', function() {
            if (checkbox.is(':checked')) {
                var val = $(this).val();
                lastname.val(val);
                company.val(val);
                if(firstname.val() !== 'Legal Entity') firstname.val('Legal Entity');
            }
        });

        checkbox.on('change', function() { toggleLegal(false); });
        toggleLegal(true);

        var regionSelect = $('#region_id');
        var cityInput = $('#city');
        var citySelect = $('#city_select');
        var currentCity = '<?= $block->escapeJs($block->getAddress()->getCity()) ?>';

        function loadCities(regionId) {
            if(!regionId) return;
            $.ajax({
                url: url.build('legalperson/city/index'),
                data: { region_id: regionId },
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    if(data.length > 0) {
                        citySelect.find('option:not(:first)').remove();
                        $.each(data, function(index, item){
                            citySelect.append($('<option>', {
                                value: item.value,
                                text: item.label,
                                selected: (item.value == currentCity)
                            }));
                        });

                        cityInput.hide();
                        cityInput.prop('disabled', true);
                        citySelect.show();
                    } else {
                        cityInput.show();
                        cityInput.prop('disabled', false);
                        citySelect.hide();
                    }
                }
            });
        }

        regionSelect.on('change', function(){
            loadCities($(this).val());
        });
        citySelect.on('change', function(){
            cityInput.prop('disabled', false);
            cityInput.val($(this).val());
            cityInput.prop('disabled', true);
        });

        if(regionSelect.val()) {
            loadCities(regionSelect.val());
        }
    });
</script>
